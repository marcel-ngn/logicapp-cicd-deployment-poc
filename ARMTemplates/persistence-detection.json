{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Persistence-Detection",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure monitor",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"#  **Privileged Role Assignments **\"},\"name\":\"text - 4 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Add member to role\\\",\\n    \\\"Add eligible member to role\\\", \\n    \\\"Add scoped member to role\\\",\\n    \\\"Add member to role scoped over Restricted Management Administrative Unit\\\",\\n    \\\"Add member to role completed (PIM activation)\\\",\\n    \\\"Update role definition\\\"\\n)\\n| extend RoleName = tostring(TargetResources[0].displayName)\\n| extend PrincipalName = tostring(TargetResources[1].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend PrincipalId = tostring(TargetResources[1].id)\\n| project TimeGenerated, OperationName, RoleName, PrincipalName, PrincipalId, InitiatedBy, CorrelationId, Result, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Privileged Role Assignments\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"Privileged Role Assignments\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\\"Add member to role\\\", \\\"Add eligible member to role\\\")\\n| extend RoleName = tostring(TargetResources[0].displayName)\\n| where RoleName in (\\n    \\\"Partner Tier2 Support\\\",\\n    \\\"Partner Tier1 Support\\\", \\n    \\\"Directory Synchronization Accounts\\\"\\n)\\n| extend PrincipalName = tostring(TargetResources[1].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| project TimeGenerated, OperationName, RoleName, PrincipalName, InitiatedBy, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Hidden Privileged Role Assignments\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"Hidden Privileged Role Assignments\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName contains \\\"Administrative Unit\\\"\\n| extend UnitName = tostring(TargetResources[0].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend TargetUser = tostring(TargetResources[1].displayName)\\n| project TimeGenerated, OperationName, UnitName, TargetUser, InitiatedBy, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Administrative Unit Activities\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\\"Add member to role\\\", \\\"Remove member from role\\\")\\n| extend RoleName = tostring(TargetResources[0].displayName)\\n| where RoleName == \\\"Global Administrator\\\"\\n| extend PrincipalName = tostring(TargetResources[1].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| project TimeGenerated, OperationName, RoleName, PrincipalName, InitiatedBy, CorrelationId, Result\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Global Administrator Role Changes\",\"noDataMessageStyle\":3,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\\"Add member to role\\\", \\\"Remove member from role\\\")\\n| extend RoleName = tostring(TargetResources[0].displayName)\\n| where RoleName == \\\"Global Administrator\\\"\\n| extend PrincipalName = tostring(TargetResources[1].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| project TimeGenerated, OperationName, RoleName, PrincipalName, InitiatedBy, CorrelationId, Result\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Global Administrator Role Changes\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 3 - Copy\"},{\"type\":1,\"content\":{\"json\":\"#  **APPLICATIONS CATEGORY**\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Update application - Certificates and secrets management\\\",\\n    \\\"Add service principal credentials\\\"\\n)\\n| extend AppName = tostring(TargetResources[0].displayName)\\n| extend AppId = tostring(TargetResources[0].id)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend ModifiedProperties = tostring(TargetResources[0].modifiedProperties)\\n| project TimeGenerated, OperationName, AppName, AppId, InitiatedBy, ModifiedProperties, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Application Credential Additions \",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Consent to application\\\",\\n    \\\"Add delegated permission grant\\\",\\n    \\\"Add app role assignment to service principal\\\"\\n)\\n| extend AppName = tostring(TargetResources[0].displayName)\\n| extend ConsentedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend ConsentType = case(\\n    OperationName == \\\"Consent to application\\\", \\\"User Consent\\\",\\n    OperationName == \\\"Add delegated permission grant\\\", \\\"Delegated Permission\\\",\\n    \\\"App Role Assignment\\\"\\n)\\n// Parse the complex permissions structure\\n| extend ModifiedPropsRaw = tostring(TargetResources[0].modifiedProperties)\\n| extend ModifiedProps = parse_json(ModifiedPropsRaw)\\n| mv-expand ModifiedProps\\n| extend PropName = tostring(ModifiedProps.displayName)\\n| extend PropNewValue = tostring(ModifiedProps.newValue)\\n// Extract admin consent info\\n| extend IsAdminConsent = case(PropName == \\\"ConsentContext.IsAdminConsent\\\", PropNewValue, \\\"\\\")\\n| extend IsAppOnly = case(PropName == \\\"ConsentContext.IsAppOnly\\\", PropNewValue, \\\"\\\")\\n| extend OnBehalfOfAll = case(PropName == \\\"ConsentContext.OnBehalfOfAll\\\", PropNewValue, \\\"\\\")\\n// Extract permissions from the ConsentAction.Permissions field\\n| extend PermissionsRaw = case(PropName == \\\"ConsentAction.Permissions\\\", PropNewValue, \\\"\\\")\\n| extend ScopeStart = indexof(PermissionsRaw, \\\"Scope: \\\")\\n| extend ScopeEnd = indexof(PermissionsRaw, \\\", CreatedDateTime:\\\")\\n| extend PermissionsScope = case(\\n    ScopeStart >= 0 and ScopeEnd > ScopeStart, \\n    substring(PermissionsRaw, ScopeStart + 7, ScopeEnd - ScopeStart - 7),\\n    \\\"\\\"\\n)\\n// Extract ClientId and ResourceId\\n| extend ClientIdStart = indexof(PermissionsRaw, \\\"ClientId: \\\")\\n| extend ClientIdEnd = indexof(PermissionsRaw, \\\", PrincipalId:\\\")\\n| extend ClientId = case(\\n    ClientIdStart >= 0 and ClientIdEnd > ClientIdStart,\\n    substring(PermissionsRaw, ClientIdStart + 10, ClientIdEnd - ClientIdStart - 10),\\n    \\\"\\\"\\n)\\n| extend ResourceIdStart = indexof(PermissionsRaw, \\\"ResourceId: \\\")\\n| extend ResourceIdEnd = indexof(PermissionsRaw, \\\", ConsentType:\\\")\\n| extend ResourceId = case(\\n    ResourceIdStart >= 0 and ResourceIdEnd > ResourceIdStart,\\n    substring(PermissionsRaw, ResourceIdStart + 12, ResourceIdEnd - ResourceIdStart - 12),\\n    \\\"\\\"\\n)\\n// Summarize by correlation ID to group all properties together\\n| summarize \\n    AppName = any(AppName),\\n    ConsentedBy = any(ConsentedBy),\\n    ConsentType = any(ConsentType),\\n    IsAdminConsent = any(IsAdminConsent),\\n    IsAppOnly = any(IsAppOnly), \\n    OnBehalfOfAll = any(OnBehalfOfAll),\\n    PermissionsScope = any(PermissionsScope),\\n    ClientId = any(ClientId),\\n    ResourceId = any(ResourceId),\\n    TimeGenerated = any(TimeGenerated)\\n    by CorrelationId, OperationName\\n// Clean up and format permissions for better readability\\n| extend CleanPermissions = replace_string(replace_string(PermissionsScope, \\\" \\\", \\\" â€¢ \\\"), \\\"  \\\", \\\" \\\")\\n| extend PermissionsList = split(PermissionsScope, \\\" \\\")\\n| extend HighRiskPermissions = array_length(extract_all(@\\\"(Directory\\\\.ReadWrite\\\\.All|RoleManagement\\\\.ReadWrite\\\\.Directory|Application\\\\.ReadWrite\\\\.All|User\\\\.ReadWrite\\\\.All|Mail\\\\.ReadWrite|Files\\\\.ReadWrite\\\\.All)\\\", CleanPermissions))\\n| extend RiskLevel = case(\\n    HighRiskPermissions > 0, \\\"HIGH\\\",\\n    array_length(PermissionsList) > 10, \\\"MEDIUM\\\", \\n    \\\"LOW\\\"\\n)\\n| project \\n    TimeGenerated,\\n    RiskLevel,\\n    OperationName,\\n    ConsentType,\\n    AppName,\\n    ConsentedBy,\\n    IsAdminConsent,\\n    OnBehalfOfAll,\\n    CleanPermissions,\\n    ClientId,\\n    ResourceId,\\n    CorrelationId\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"OAuth Consent Grants\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName == \\\"Add application\\\"\\n| extend AppName = tostring(TargetResources[0].displayName)\\n| extend AppId = tostring(TargetResources[0].id)\\n| extend CreatedBy_DisplayName = tostring(InitiatedBy.user.displayName)\\n| extend CreatedBy_UPN = tostring(InitiatedBy.user.userPrincipalName)\\n| extend CreatedBy_UserId = tostring(InitiatedBy.user.id)\\n| extend CreatedBy_IPAddress = tostring(InitiatedBy.user.ipAddress)\\n| project TimeGenerated, OperationName, AppName, AppId, CreatedBy_DisplayName, CreatedBy_UPN, CreatedBy_UserId, CreatedBy_IPAddress, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"New Application Registrations\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\\"Consent to application\\\", \\\"Add delegated permission grant\\\")\\n| extend AppName = tostring(TargetResources[0].displayName)\\n| extend ConsentedBy = tostring(InitiatedBy.user.displayName)\\n| extend ConsentedBy_UPN = tostring(InitiatedBy.user.userPrincipalName)\\n// Extract permissions from the complex JSON structure\\n| extend ModifiedPropsRaw = tostring(TargetResources[0].modifiedProperties)\\n| extend PermissionsExtract = extract(@\\\"Scope: ([^,]+)\\\", 1, ModifiedPropsRaw)\\n// Check for high-risk permissions\\n| where PermissionsExtract contains \\\"Directory.ReadWrite.All\\\" or \\n       PermissionsExtract contains \\\"RoleManagement.ReadWrite.Directory\\\" or\\n       PermissionsExtract contains \\\"Application.ReadWrite.All\\\" or\\n       PermissionsExtract contains \\\"User.ReadWrite.All\\\" or\\n       PermissionsExtract contains \\\"Mail.ReadWrite\\\" or\\n       PermissionsExtract contains \\\"Files.ReadWrite.All\\\" or\\n       PermissionsExtract contains \\\"AppRoleAssignment.ReadWrite.All\\\"\\n// Extract admin consent status\\n| extend IsAdminConsent = case(\\n    ModifiedPropsRaw contains \\\"IsAdminConsent.*True\\\", \\\"Admin Consent\\\",\\n    ModifiedPropsRaw contains \\\"IsAdminConsent.*False\\\", \\\"User Consent\\\",\\n    \\\"Unknown\\\"\\n)\\n// Extract and format the permissions in a readable way\\n| extend HighRiskPermissions = extract_all(@\\\"(Directory\\\\.ReadWrite\\\\.All|RoleManagement\\\\.ReadWrite\\\\.Directory|Application\\\\.ReadWrite\\\\.All|User\\\\.ReadWrite\\\\.All|Mail\\\\.ReadWrite|Files\\\\.ReadWrite\\\\.All|AppRoleAssignment\\\\.ReadWrite\\\\.All)\\\", PermissionsExtract)\\n| extend Permissions = replace_string(PermissionsExtract, \\\" \\\", \\\" â€¢ \\\")\\n// Extract Client and Resource IDs for reference\\n| extend ClientId = extract(@\\\"ClientId: ([a-f0-9\\\\-]+)\\\", 1, ModifiedPropsRaw)\\n| extend ResourceId = extract(@\\\"ResourceId: ([a-f0-9\\\\-]+)\\\", 1, ModifiedPropsRaw)\\n| project \\n    TimeGenerated,\\n    OperationName,\\n    AppName,\\n    ConsentedBy,\\n    ConsentedBy_UPN,\\n    IsAdminConsent,\\n    HighRiskPermissions,\\n    Permissions\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"High-Risk Permission Grants\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName contains \\\"service principal\\\" or OperationName contains \\\"application\\\"\\n| extend ServicePrincipal = tostring(TargetResources[0].displayName)\\n| extend InitiatedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| project TimeGenerated, OperationName, ServicePrincipal, InitiatedBy, CorrelationId, AdditionalDetails\\n| order by ServicePrincipal, TimeGenerated desc\",\"size\":0,\"title\":\"Application Activities Timeline\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 17\"},{\"type\":1,\"content\":{\"json\":\"#  **ðŸ” AUTHENTICATION CATEGORY**\"},\"name\":\"text - 4 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Update conditional access policy\\\",\\n    \\\"Delete Conditional access policy\\\",\\n    \\\"Add conditional access policy\\\",\\n    \\\"Update named location\\\",\\n    \\\"Update security defaults\\\"\\n)\\n| extend PolicyName = tostring(TargetResources[0].displayName)\\n| extend ModifiedBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend ModifiedProperties = tostring(TargetResources[0].modifiedProperties)\\n| project TimeGenerated, OperationName, PolicyName, ModifiedBy, ModifiedProperties, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Conditional Access Policy Modifications\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\n| where TimeGenerated >= ago(30d)\\n| where AuthenticationDetails has_any (\\\"Temporary Access Pass\\\", \\\"TAP\\\")\\n| extend TAPUser = UserPrincipalName\\n| extend AuthMethod = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\\n| project TimeGenerated, TAPUser, AppDisplayName, IPAddress, DeviceDetail, LocationDetails, RiskLevelDuringSignIn, AuthMethod, CorrelationId\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Temporary Access Pass (TAP) Usage \",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Admin registered security info\\\",\\n    \\\"Admin deleted security info\\\",\\n    \\\"Admin registered temporary access pass method for user\\\"\\n)\\n| extend TargetUser = tostring(TargetResources[0].userPrincipalName)\\n| extend RegisteredBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| extend AuthMethod = tostring(TargetResources[0].displayName)\\n| project TimeGenerated, OperationName, TargetUser, RegisteredBy, AuthMethod\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"Admin Security Info Registrations\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName == \\\"Admin registered security info\\\"\\n| where AdditionalDetails contains \\\"FIDO2\\\" or TargetResources[0].displayName contains \\\"FIDO2\\\"\\n| extend TargetUser = tostring(TargetResources[0].userPrincipalName)\\n| extend RegisteredBy = tostring(InitiatedBy.user.displayName)\\n| extend AuthMethod = tostring(TargetResources[0].displayName)\\n| project TimeGenerated, OperationName, TargetUser, RegisteredBy, AuthMethod, CorrelationId, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"title\":\"FIDO2 Token Registrations by Admins\",\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\n| where TimeGenerated >= ago(30d)\\n| where OperationName in (\\n    \\\"Reset password\\\",\\n    \\\"Admin started password reset\\\",\\n    \\\"Change user password\\\"\\n)\\n| extend TargetUser = tostring(TargetResources[0].userPrincipalName)\\n| extend ResetBy = case(\\n    isnotempty(InitiatedBy.user.displayName), tostring(InitiatedBy.user.displayName),\\n    isnotempty(InitiatedBy.app.displayName), strcat(\\\"App: \\\", tostring(InitiatedBy.app.displayName)),\\n    \\\"System\\\"\\n)\\n| project TimeGenerated, OperationName, TargetUser, ResetBy, Result, AdditionalDetails\\n| order by TimeGenerated desc\",\"size\":0,\"noDataMessageStyle\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/bfa993ea-b959-4682-916c-664469cd5f6a/resourceGroups/RG-GoldenReferences-CAUTION/providers/Microsoft.OperationalInsights/workspaces/LOG-Sentinel-Reference\"]},\"name\":\"query - 16\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure monitor\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}